<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">

<script src="paper-full.min.js"></script>
<link href="Oswald-Light" rel="stylesheet">

<style>
    * {
        font-family: 'Oswald', sans-serif;
    }

.btn-guardar {
    padding:5px;
    background-color:rgb(252,47,106);
    color:white;
    border-radius: 4px;
    text-decoration:none;
    display:inline-block;
    font-size:10px;
    margin-top:8px;
    margin-right:5px;
    float:right;
}

.btn-color {
    width:20px;
    height:20px;
    border-radius: 50%;
    display:inline-block;
    border:2px solid white;
    margin-top:8px;
    margin-left:5px;
    float:left;
}

.btn-stroke {
    width:20px;
    height:20px;
    float:left;
    border-radius: 50%;
    display:inline-block;
    border:1px dotted white;
    margin-top:8px;
    margin-left:5px;
    text-align:center;
    font-size:16px;
    text-decoration:none;
    color:black;
}

.btn-stroke.activo {
    border-color:black;
}

.btn-color.red {
    background-color:red;
}
.btn-color.blue {
    background-color:blue;
}
.btn-color.green {
    background-color:green;
    margin-right:20px;
}

.btn-color.activo {
    border-color:black;
}
</style>


<script>
    
paper.install(window);
var plantilla = "";
var trazo = "";
var lastZoomScale;
var puntoIni;
var medio;
var canvas;
var path;
var loadImage;
var action = "draw";
var mode = "draw";
var raster;
var raster_img;
var colorActivo = "red";
var strockActivo = 3;
var canvasExport;
var projectExport;


window.onload = function() {
    
	canvas = document.getElementById('myCanvas');
    
    //CANVAS EXPORT
    canvasExport = document.createElement('canvas');
    canvasExport.width = 3056/2;
    canvasExport.height = 1761/2;
    projectExport = new Project(canvasExport);
    raster_img = new Raster(plantilla,new Point(3056/4, 1761/4));
    if(trazo != "") {
        projectExport.importJSON(trazo);
    }
    
    
    //INIT
	paper.setup(canvas);
    raster = new Raster(plantilla,new Point(3056/4, 1761/4));
    
    if(trazo != "") {
        paper.importJSON(trazo);
        view.update();
    }
    
    raster.onLoad = function() {
        //webkit.messageHandlers.loginAction.postMessage( view.matrix );
        //rvar width = paper.view.size.width;
        //var scale = (width / raster.bounds.width);
        //raster.scale(scale);
    };
    
    //view.zoom = 0.35;
    
    
	//raster = new Raster('plantilla');
	// Create a Paper.js Path to draw a line into it:
/*
	path = new Path.Rectangle([view.center.x-50, view.center.y-50], [100, 100]);
	path.strokeColor = 'black';
*/
	/*
	view.onFrame = function(event) {
			// On each frame, rotate the path by 3 degrees:
			path.rotate(0.5);
		}
		*/
	canvas.addEventListener("touchstart", startHandler, false);
	canvas.addEventListener("touchmove", moveHandler, false);
	canvas.addEventListener("touchend",endHandler,false);

	var tool = new Tool();
    
	tool.onMouseDown = function(event) {

		//alert(event.changedTouches);
		if(action == "draw"){
			if(mode == "draw"){
				path = new Path();
				path.strokeColor = colorActivo;
				path.blendMode = 'normal';
                path.strokeWidth = strockActivo;
			}

			if(mode == "erase"){
				path = new Path();
				path.strokeColor = "red";
				path.blendMode = 'destination-out';
				path.strokeWidth = 30
			}
		}

	}

	tool.onMouseDrag = function(event) {
		if(action == "draw"){
			path.add(event.point);
		}

	}

	tool.onMouseUp = function(event) {
		if(action == "draw"){
			path.simplify();

			var lay = projectExport.activeLayer;
			lay.addChild(path.clone());

		}

	}

}


function startHandler(event){
    

    //event.preventDefault();
    if(event.targetTouches.length == 1){
	 
	}



	if(event.targetTouches.length == 2){

		var p1 = event.targetTouches[0];
		var p2 = event.targetTouches[1];
		puntoIni = new Point(p1.pageX,p1.pageY);
		var lastZoomScale = Math.sqrt(Math.pow(p2.pageX - p1.pageX, 2) + Math.pow(p2.pageY - p1.pageY, 2));

		medio = new Point( (p1.pageX + p2.pageX)/2 , (p1.pageY+p2.pageY)/2 );
		medio =  view.viewToProject(medio);
		action = "zoom";

	} else if(event.targetTouches.length == 1){
			action = "draw";
	}

}



function moveHandler(event){
	event.preventDefault();
	var zoom = false;




	if(event.targetTouches.length == 2){


		var p1 = event.targetTouches[0];
		var p2 = event.targetTouches[1];

		var zoomScale = Math.sqrt(Math.pow(p2.pageX - p1.pageX, 2) + Math.pow(p2.pageY - p1.pageY, 2));
		zoomScale = zoomScale * 0.3;
		if( lastZoomScale ) {
		   zoom = zoomScale - lastZoomScale;
		}

		lastZoomScale = zoomScale;

	}

	if(zoom){

		var total = (view.zoom + (zoom/100));
		//view.zoom = total;

		var a, beta, pc;
		beta = view.zoom / total;


		medio2 = new Point( (p1.pageX + p2.pageX)/2 , (p1.pageY+p2.pageY)/2 );
		medio2 =  view.viewToProject(medio2);

		pc = medio.subtract(view.center);
		a = medio.subtract(pc.multiply(beta)).subtract(view.center);

		var offset = medio.subtract(medio2);

		view.zoom = total;
		view.center = view.center.add(a).add(offset);


	}

}

function endHandler(event){
	lastZoomScale  = null;
	action = "draw";
}

function exportar() {
    //raster.remove();
    //var json = paperScope.project.exportJSON();
    
    var p1 = new Promise(
                         function(resolve, reject) {
                         
                             if(true) {
                         
                                //view.zoom = 1;
                                view.update();
                         
                                //var canvasJson = project.exportJSON();
                                //canvasExportProject.importJSON(canvasJson);
                                //canvasExportProject.view.update();
                                //canvasExportProject
                         
                                //raster = new Raster(plantilla,new Point(3056/4, 1761/4));
                                dibujo = canvasExport.toDataURL();
                                raster_img.remove();
                                projectExport.view.update();
                                trazo = canvasExport.toDataURL();
                                trazoJSON = projectExport.exportJSON();
                         
                                var data = {
                                    trazo: trazo,
                                    trazoJSON: trazoJSON,
                                    dibujo: dibujo
                                }
                                webkit.messageHandlers.loginAction.postMessage( data );
                         
                             }
                         
                         }
             );
         
         p1.then(
             // Registrar el valor de la promesa cumplida
             function(val) {
                 webkit.messageHandlers.loginAction.postMessage("desde js");
             })
             .catch(
                // Registrar la raz√≥n del rechazo
                function(reason) {
                webkit.messageHandlers.loginAction.postMessage(reason.toString());
        }
    );
}

function changeColor(color){
    
    colorActivo = color;
    var aca = document.querySelectorAll('.btn-color');
    aca[0].classList.remove('activo');
    aca[1].classList.remove('activo');
    aca[2].classList.remove('activo');
    
    var nuevoActivo = document.querySelector('#'+color);
    nuevoActivo.classList.add('activo');
    
}

function changeStroke(stroke){
    strockActivo = stroke;
    
    var aca = document.querySelectorAll('.btn-stroke');
    aca[0].classList.remove('activo');
    aca[1].classList.remove('activo');
    aca[2].classList.remove('activo');
    
    var nuevoActivo = document.querySelector('#s-'+stroke);
    nuevoActivo.classList.add('activo');
}

</script>
</head>

<body style="padding:0; margin:0">
    <div style="position:absolute; width:100%; height:40px; background-color:rgb(255,255,255); z-index:99; border-bottom:1px solid #f1f1f1">
        <a href="javascript:exportar()" class="btn-guardar exportar">GUARDAR</a>
        <a href="javascript:changeColor('red')" class="btn-color red activo" id="red"></a>
        <a href="javascript:changeColor('blue')" class="btn-color blue" id="blue"></a>
        <a href="javascript:changeColor('green')" class="btn-color green" id="green"></a>
        
        <a href="javascript:changeStroke(3)" class="btn-stroke sn activo" id="s-3">|</a>
        <a href="javascript:changeStroke(5)" class="btn-stroke sm" id="s-5">||</a>
        <a href="javascript:changeStroke(7)" class="btn-stroke sa" id="s-7">|||</a>
        
    </div>
    
    <canvas resize id="myCanvas" style="width:100%; height:100%; position:absolute; z-index:1; border:0 "></canvas>
</body>
</html>
